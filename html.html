<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outil d'Analyse de Données Gemini</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f4f4f9; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
        }
        .main-wrapper {
            width: 95%; 
            max-width: 1400px; 
            height: 90vh;
            display: flex;
            background-color: #fff; 
            border-radius: 8px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); 
            overflow: hidden;
        }
        
        /* Panneau de l'Historique (Côté Gauche) */
        #history-panel {
            width: 300px; 
            background-color: #363640; 
            color: #f4f4f4;
            border-right: 1px solid #222;
            padding: 0; 
            overflow-y: auto;
            flex-shrink: 0;
        }
        #history-panel h2 {
            font-size: 1.2em;
            color: #f4f4f4;
            padding: 15px;
            margin: 0;
            border-bottom: 1px solid #444;
            text-align: center;
        }
        .history-date-header {
            font-size: 0.9em; 
            padding: 10px 15px 5px 15px; 
            margin: 0; 
            background-color: #4b4b57; 
            color: #fff;
            font-weight: bold;
            border-top: 1px solid #333;
            position: sticky; 
            top: 0;
            z-index: 5;
        }
        .history-item {
            padding: 8px 15px; 
            cursor: pointer; 
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-item:hover {
            background-color: #5a5a6a; 
        }
        .history-item-text {
            flex-grow: 1;
            font-size: 0.9em;
            color: #d1d1d1;
            padding-right: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .history-item-delete {
            margin-left: 10px;
            color: #ff6b6b;
            cursor: pointer;
            font-weight: bold;
            line-height: 1;
            border: none;
            background: none;
            padding: 0;
            z-index: 10;
        }
        .history-item-delete:hover {
            color: #ff3838;
        }
        .history-item-text strong { 
            color: #a0a0a0;
        }


        /* Conteneur Principal de la Discussion (Côté Droit) */
        .chat-container { 
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            padding: 25px; 
        }
        h1 { color: #333; text-align: center; margin-bottom: 20px; font-size: 1.8em; }
        #chat-window { 
            border: 1px solid #ddd; 
            flex-grow: 1; 
            overflow-y: scroll; 
            padding: 15px; 
            margin-bottom: 15px; 
            background-color: #fafafa; 
            border-radius: 4px; 
        }
        
        /* Styles de Message */
        .message { margin-bottom: 15px; padding: 10px; border-radius: 6px; line-height: 1.5; }
        .user-message { background-color: #e6f7ff; text-align: right; margin-left: 20%; border: 1px solid #b3e0ff; }
        .gemini-message { background-color: #e0ffe0; text-align: left; margin-right: 20%; border: 1px solid #b3ffb3; }
        .system-message { background-color: #fff3cd; color: #856404; text-align: center; border: 1px solid #ffeeba; font-size: 0.9em; margin-left: 10%; margin-right: 10%; }
        
        /* Zone d'Input */
        .input-area { display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; }
        #prompt-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: none; }
        
        /* Alignement des boutons */
        .bottom-row > div:first-child { display: flex; align-items: center; gap: 10px; } 

        #file-input-label { display: inline-block; padding: 8px 15px; background-color: #007bff; color: white; border-radius: 4px; cursor: pointer; text-align: center; }
        #file-input-label:hover { background-color: #0056b3; }
        
        #show-data-button { padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        #show-data-button:hover:not(:disabled) { background-color: #5a6268; }
        #show-data-button:disabled { background-color: #adb5bd; cursor: not-allowed; } 

        #send-button { padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #send-button:hover { background-color: #1e7e34; }
        .bottom-row { display: flex; justify-content: space-between; align-items: center; }
        .file-info { font-size: 0.8em; color: #555; margin-top: 5px; font-style: italic; } 
        .loading { text-align: center; padding: 10px; color: #007bff; }
    </style>
</head>
<body onload="loadHistory()">
    <div class="main-wrapper">
        <div id="history-panel">
            <h2>Analyses Récentes</h2> 
            <button id="new-thread-button" style="width: 90%; margin: 10px 5%; padding: 8px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="showNewDiscussionView()">+ Nouvelle Analyse</button> 
            <div id="history-list">
                </div>
        </div>

        <div class="chat-container">
            <h1 id="chat-title" data-thread-id="0">Nouvelle Analyse</h1> 
            
            <div id="chat-window">
                                <div class="message gemini-message initial-message">
                    Bienvenue! Pour commencer, veuillez **déposer votre fichier** ou **taper votre requête** dans le champ ci-dessous. Nous analyserons les **erreurs de caisse, les pertes de stock et les anomalies de vente** de manière automatique.
                </div>
            </div>

            <form id="chat-form" class="input-area">
                <div class="bottom-row">
                    <div>
                        <input type="file" id="file-input" name="files" style="display: none;" multiple>
                        <label for="file-input" id="file-input-label">Ajouter Fichiers</label>
                        <button type="button" id="show-data-button" disabled>Aperçu des Données</button>
                    </div>
                </div>
                <div id="file-name" class="file-info">Aucun fichier sélectionné.</div>
                
                                <textarea 
                    id="prompt-input" 
                    rows="3" 
                    placeholder="Déposez votre fichier ci-dessous et laissez le système détecter les erreurs de caisse, les pertes de stock et les anomalies de vente"
                ></textarea>
                
                <div class="bottom-row">
                    <div></div>
                    <button type="submit" id="send-button">Envoyer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="data-modal" style="display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background-color: rgba(0,0,0,0.4);">
        <div style="background-color:#fefefe; margin: 5% auto; padding:20px; border:1px solid #888; width:80%; height:80%; border-radius:8px; display:flex; flex-direction:column;">
            <span id="close-modal" style="color:#aaa; align-self:flex-end; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
            <h2>Aperçu des Données Brutes</h2>
            <div id="modal-content-wrapper" style="flex-grow:1; overflow:hidden; border:1px solid #ccc; background-color: #eee; display: flex; flex-direction: column;">
                <pre id="text-view" style="font-family: monospace; white-space: pre-wrap; padding:10px; overflow-y: auto; flex-grow: 1;"></pre>
                <div id="html-view" style="display:none; width: 100%; height: 100%; flex-grow: 1; padding: 10px;"></div>
            </div>
        </div>
    </div>

    <script>
        const chatForm = document.getElementById('chat-form');
        const chatWindow = document.getElementById('chat-window');
        const promptInput = document.getElementById('prompt-input');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name');
        const sendButton = document.getElementById('send-button');
        const historyListDiv = document.getElementById('history-list');
        const chatTitle = document.getElementById('chat-title');
        
        // Constantes de la modale d'affichage
        const showDataButton = document.getElementById('show-data-button');
        const dataModal = document.getElementById('data-modal');
        const closeModalButton = document.getElementById('close-modal');
        const textView = document.getElementById('text-view');
        const htmlView = document.getElementById('html-view');
        
        
        // --- FONCTIONS UTILITAIRES DE L'INTERFACE ---

        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function showNewDiscussionView() {
            chatTitle.textContent = "Nouvelle Analyse";
            chatTitle.setAttribute('data-thread-id', '0'); 
            
                        chatWindow.innerHTML = `<div class="message gemini-message initial-message">
                Bienvenue! Pour commencer, veuillez **déposer votre fichier** ou **taper votre requête** dans le champ ci-dessous. Nous analyserons les **erreurs de caisse, les pertes de stock et les anomalies de vente** de manière automatique.
            </div>`;
            resetFileInputs();
            document.querySelectorAll('.history-item').forEach(item => item.style.backgroundColor = '');
        }

        function resetFileInputs() {
            fileInput.value = ''; 
            fileNameDisplay.textContent = 'Aucun fichier sélectionné.';
            showDataButton.disabled = true;
        }

        function appendMessage(text, className, fileInfo = null) { 
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`;
            
            if (fileInfo) { 
                const infoDiv = document.createElement('div');
                infoDiv.className = 'file-info';
                infoDiv.textContent = `[Fichiers : ${fileInfo}]`;
                messageDiv.appendChild(infoDiv);
            }
            
            const contentDiv = document.createElement('div');
            // Utilisation de innerHTML et remplacement de \n par <br> pour la mise en forme du texte
            contentDiv.innerHTML = text.replace(/\n/g, '<br>'); 
            
            messageDiv.appendChild(contentDiv); 

            chatWindow.appendChild(messageDiv);
            scrollToBottom();
            return messageDiv;
        }

        // --- GESTION DES FICHIERS ---
        fileInput.addEventListener('change', () => {
            const files = fileInput.files;
            if (files.length > 0) {
                let fileNames = '';
                for (let i = 0; i < files.length; i++) {
                    fileNames += files[i].name;
                    if (i < files.length - 1) {
                        fileNames += ', ';
                    }
                }
                fileNameDisplay.textContent = `${files.length} fichier(s) sélectionné(s): ${fileNames}`;
                showDataButton.disabled = false;
            } else {
                fileNameDisplay.textContent = 'Aucun fichier sélectionné.';
                showDataButton.disabled = true;
            }
        });

        // --- GESTION DE L'AFFICHAGE DES DONNÉES BRUTES (APERÇU) ---
        closeModalButton.onclick = function() {
            dataModal.style.display = "none";
        }
        window.onclick = function(event) {
            if (event.target == dataModal) {
                dataModal.style.display = "none";
            }
        }
        
        showDataButton.addEventListener('click', () => {
            const files = fileInput.files;
            if (files.length === 0) return;
            
            dataModal.style.display = "block";
            
            // Réinitialisation de la vue
            textView.style.display = 'block';
            htmlView.style.display = 'none';
            textView.textContent = "Chargement des données...";
            htmlView.innerHTML = '';
            
            let allTextContent = '';
            let filesProcessed = 0;
            
            for (const file of files) {
                const fileExtension = file.name.split('.').pop().toLowerCase();

                // 1. GESTION DES FICHIERS PDF (Affichage direct dans l'iframe du navigateur, si fichier unique)
                if (fileExtension === 'pdf' && files.length === 1) {
                    textView.style.display = 'none';
                    htmlView.style.display = 'flex';
                    
                    // Crée une URL locale pour le navigateur
                    const objectURL = URL.createObjectURL(file);
                    
                    htmlView.innerHTML = `
                        <div style="padding: 10px; border: 1px solid #007bff; margin-bottom: 10px; background-color: #e6f7ff; color: #333; font-size: 0.9em;">
                            Aperçu du PDF (directement par le navigateur).
                        </div>
                        <iframe src="${objectURL}" style="width: 100%; height: 90%; border: 1px solid #ccc; flex-grow: 1;"></iframe>`;
                        
                    filesProcessed++;
                    break; // S'arrête après l'affichage du PDF
                }
                
                // 2. GESTION DES FICHIERS EXCEL (.xlsx, .xls)
                if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                    // CORRECTION: Réintroduction d'un message pour éviter un affichage vide
                    allTextContent += `--- Fichier: ${file.name} ---\n[Type Excel: Aperçu brut non disponible. Le fichier sera analysé par Gemini.]\n\n`;
                    filesProcessed++;
                    if (filesProcessed === files.length) {
                        textView.textContent = allTextContent;
                    }
                    continue;
                }

                // 3. GESTION DES FICHIERS HTML (Affichage dans iframe pour le rendu, si fichier unique)
                if (fileExtension === 'html' && files.length === 1) {
                    textView.style.display = 'none';
                    htmlView.style.display = 'flex';
                    htmlView.innerHTML = "Chargement du rendu HTML...";
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result;
                        const limitSize = 1024 * 1024; // Limite à 1MB pour l'aperçu
                        const truncatedContent = content.substring(0, limitSize); 
                        
                        // CORRECTION: Suppression du div d'avertissement
                        htmlView.innerHTML = `
                            <iframe style="width: 100%; height: 100%; border: 1px solid #ccc; flex-grow: 1;"></iframe>`;
                        
                        const iframe = htmlView.querySelector('iframe');
                        const doc = iframe.contentWindow.document;
                        
                        doc.open();
                        doc.write(truncatedContent);
                        
                        if (content.length > truncatedContent.length) {
                             doc.write('<div style="color: red; padding: 10px; font-weight: bold;">... [Rapport tronqué pour l\'aperçu.] ...</div>');
                        }
                        doc.close();
                        filesProcessed++;
                    };
                    reader.readAsText(file);
                    break; 
                }

                // 4. GESTION DES FICHIERS TEXTE (CSV, JSON, TXT, HTML brut si multi-fichiers)
                if (!file.type.startsWith('text/') && !fileExtension.match(/^(csv|json|txt|html)$/)) {
                    allTextContent += `--- Fichier: ${file.name} ---\n[Type de fichier non affichable (seulement texte, CSV, JSON, TXT, HTML, PDF sont supportés pour l'aperçu).] \n\n`;
                    filesProcessed++;
                    if (filesProcessed === files.length) {
                        textView.textContent = allTextContent;
                    }
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    allTextContent += `--- Contenu Brute du Fichier: ${file.name} (${(file.size / 1024).toFixed(2)} KB) ---\n`;
                    
                    const content = e.target.result;
                    allTextContent += content.substring(0, 5000); 
                    if (content.length > 5000) {
                        allTextContent += '\n... [TRONQUÉ POUR APERÇU] ...';
                    }
                    allTextContent += '\n\n';

                    filesProcessed++;
                    if (filesProcessed === files.length) {
                        textView.textContent = allTextContent;
                    }
                };
                reader.onerror = () => {
                    allTextContent += `--- Fichier: ${file.name} ---\n[Erreur de lecture du fichier]\n\n`;
                    filesProcessed++;
                    if (filesProcessed === files.length) {
                        textView.textContent = allTextContent;
                    }
                };
                reader.readAsText(file);
            }
        });


        // --- GESTION DE L'HISTORIQUE (THREADS) ---
        
        async function loadHistory() {
            try {
                const response = await fetch('/api/history');
                if (!response.ok) throw new Error('Erreur de chargement de l\'historique');
                const data = await response.json();
                
                historyListDiv.innerHTML = '';
                
                const discussionsByDay = {};

                data.history.forEach(item => {
                    const dateKey = item.date.substring(0, 10);
                    
                    if (!discussionsByDay[dateKey]) {
                        discussionsByDay[dateKey] = [];
                    }
                    discussionsByDay[dateKey].push(item);
                });

                Object.keys(discussionsByDay).sort().reverse().forEach(dateKey => {
                    const todayKey = new Date().toISOString().substring(0, 10);
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayKey = yesterday.toISOString().substring(0, 10);
                    
                    let dateTitle = dateKey;
                    if (dateKey === todayKey) {
                        dateTitle = "Aujourd'hui";
                    } else if (dateKey === yesterdayKey) {
                        dateTitle = "Hier";
                    }
                    
                    const dateHeader = document.createElement('div');
                    dateHeader.className = "history-date-header";
                    dateHeader.textContent = dateTitle;
                    historyListDiv.appendChild(dateHeader);

                    discussionsByDay[dateKey].forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'history-item';
                        itemDiv.setAttribute('data-id', item.id);
                        itemDiv.setAttribute('data-thread-title', item.title);

                        const time = item.date.substring(11, 16); 
                        
                        itemDiv.innerHTML = `
                            <div class="history-item-text" title="${item.title}">
                                <strong style="font-size: 0.8em; display: block;">${time}</strong>
                                ${item.title.replace('...', '')}
                            </div>
                            <button class="history-item-delete" data-id="${item.id}" title="Supprimer l'analyse">X</button>
                        `;
                        
                        historyListDiv.appendChild(itemDiv);
                    });
                });

            } catch (error) {
                console.error('Erreur lors du chargement de l\'historique:', error);
                historyListDiv.innerHTML = `<div style="padding: 10px; color: red;">Erreur: ${error.message}</div>`;
            }
        }
        
        async function deleteThread(id) {
            if (!confirm(`Êtes-aho sûr de vouloir supprimer l'analyse n°${id} et ses messages ?`)) {
                return;
            }
            try {
                const response = await fetch(`/api/thread/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Échec de la suppression sur le serveur');
                
                loadHistory(); 
                
                if (chatTitle.getAttribute('data-thread-id') === String(id)) {
                    showNewDiscussionView();
                }

            } catch (error) {
                console.error('Erreur de suppression:', error);
                alert(`Erreur lors de la suppression: ${error.message}`);
            }
        }
        
        async function showThreadDetail(id, title) {
            try {
                chatTitle.textContent = title.replace('...', '');
                chatTitle.setAttribute('data-thread-id', id);

                document.querySelectorAll('.history-item').forEach(item => item.style.backgroundColor = '');
                document.querySelector(`.history-item[data-id="${id}"]`).style.backgroundColor = '#5a5a6a';

                chatWindow.innerHTML = `<div class="loading">Chargement du thread #${id}...</div>`;
                
                const response = await fetch(`/api/thread/${id}`);
                if (!response.ok) throw new Error('Impossible de charger le détail de l\'analyse.');
                
                const data = await response.json();
                
                chatWindow.innerHTML = ''; 
                
                data.messages.forEach(message => {
                    const senderClass = message.sender === 'user' ? 'user-message' : 'gemini-message';
                    
                    let fileInfoText = message.files && message.files.length > 0 
                        ? message.files.join(', ') 
                        : null;
                    
                    appendMessage(message.content, senderClass, fileInfoText);
                    
                    if (message.status !== 'Succès' && message.status !== 'En cours') {
                         appendMessage(`[Statut: ${message.status}] Une erreur s'est produite lors du traitement de ce message.`, 'system-message', null);
                    }
                });
                
            } catch (error) {
                console.error('Erreur lors de l\'affichage du détail:', error);
                chatWindow.innerHTML = `<div class="message system-message" style="color: red;">Erreur: ${error.message}</div>`;
            }
        }

        // Écouteur global pour les clics sur l'historique
        historyListDiv.addEventListener('click', (e) => {
            const itemDiv = e.target.closest('.history-item');
            if (itemDiv) {
                const id = itemDiv.getAttribute('data-id');
                const title = itemDiv.getAttribute('data-thread-title');
                
                if (e.target.classList.contains('history-item-delete')) {
                    deleteThread(id);
                } else {
                    showThreadDetail(id, title);
                }
            }
        });

        // --- GESTION DE L'ENVOI (SUBMIT) ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const prompt = promptInput.value.trim();
            const files = fileInput.files;
            const currentThreadId = chatTitle.getAttribute('data-thread-id');
            
            if (!prompt && files.length === 0) {
                alert("Veuillez entrer une question ou ajouter un fichier.");
                return;
            }

            if (currentThreadId === '0') {
                 chatWindow.innerHTML = '';
            }

            const fileInfo = files.length > 0 ? `${files.length} fichier(s)` : null;
            // On affiche le message utilisateur avant l'envoi
            appendMessage(prompt || "Analyse de fichier(s) demandée...", 'user-message', fileInfo);

            promptInput.value = '';

            const loadingMessage = appendMessage('Envoi en cours... Veuillez patienter...', 'gemini-message loading');
            sendButton.disabled = true;

            const formData = new FormData();
            formData.append('prompt', prompt);
            formData.append('thread_id', currentThreadId); 
            
            for (const file of files) {
                formData.append('files', file); 
            }

            try {
                const response = await fetch('/api/process_query', {
                    method: 'POST',
                    body: formData
                });

                chatWindow.removeChild(loadingMessage);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Erreur inconnue du serveur');
                }

                const data = await response.json();
                
                if (currentThreadId === '0') {
                    const newThreadId = data.thread_id;
                    chatTitle.setAttribute('data-thread-id', newThreadId);
                    chatTitle.textContent = (prompt.length > 50 ? prompt.substring(0, 50) + '...' : prompt);
                    
                    // On recharge l'historique et sélectionne le nouveau thread
                    loadHistory().then(() => { 
                        document.querySelectorAll('.history-item').forEach(item => item.style.backgroundColor = '');
                        const newThreadItem = document.querySelector(`.history-item[data-id="${newThreadId}"]`);
                        if (newThreadItem) {
                            newThreadItem.style.backgroundColor = '#5a5a6a';
                        }
                    });
                }

                appendMessage(data.response, 'gemini-message');
                
                // On réinitialise l'input de fichier après envoi réussi
                resetFileInputs();
                loadHistory(); 

            } catch (error) {
                if (chatWindow.contains(loadingMessage)) {
                    chatWindow.removeChild(loadingMessage);
                }
                console.error('Erreur:', error);
                appendMessage(`[Erreur] ${error.message}`, 'system-message');
            } finally {
                sendButton.disabled = false;
                scrollToBottom();
            }
        });
    </script>
</body>
</html>